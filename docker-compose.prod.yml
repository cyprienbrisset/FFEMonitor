# ============================================
# FFE Monitor - Docker Compose pour Coolify
# Un seul conteneur avec Backend + Frontend
# ============================================

services:
  ffemonitor:
    build:
      context: .
      dockerfile: Dockerfile.combined
      args:
        - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
        - NEXT_PUBLIC_API_URL=${API_URL:-}
        - NEXT_PUBLIC_ONESIGNAL_APP_ID=${ONESIGNAL_APP_ID}
    restart: unless-stopped

    # Port principal (frontend) - Coolify expose celui-ci
    ports:
      - "3000:3000"

    # Volumes
    volumes:
      - ffemonitor_data:/app/data

    # Variables d'environnement
    environment:
      # Supabase
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_JWT_SECRET=${SUPABASE_JWT_SECRET}
      # OneSignal
      - ONESIGNAL_APP_ID=${ONESIGNAL_APP_ID}
      - ONESIGNAL_API_KEY=${ONESIGNAL_API_KEY}
      # DÃ©lais notifications
      - DELAY_FREE=${DELAY_FREE:-600}
      - DELAY_PREMIUM=${DELAY_PREMIUM:-60}
      - DELAY_PRO=${DELAY_PRO:-10}
      # Application
      - CHECK_INTERVAL=${CHECK_INTERVAL:-5}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  ffemonitor_data:
