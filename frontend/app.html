<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFE Monitor ‚Äî Surveillance Concours FFE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/svg+xml" href="/static/logo.svg">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Noise texture overlay -->
    <div class="noise-overlay"></div>

    <!-- MAIN APPLICATION -->
    <div id="appScreen" class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo-wrapper">
                <img src="/static/logo.svg" alt="FFE Monitor" class="logo">
            </div>
            <div class="header-text">
                <h1>FFE Monitor</h1>
                <p class="tagline">Surveillance Premium des Concours FFE</p>
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn-theme" title="Changer de th√®me">
                    <svg class="icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                    <svg class="icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                    </svg>
                </button>
                <a href="/guide" class="btn-guide" title="Guide utilisateur">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
                    </svg>
                    <span>Guide</span>
                </a>
                <button id="logoutButton" class="btn-logout" title="Se d√©connecter">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    <span>D√©connexion</span>
                </button>
            </div>
        </header>

        <!-- Bento Grid -->
        <main class="bento-grid">
            <!-- Status Card - Large -->
            <section class="bento-card card-status">
                <div class="card-header">
                    <span class="card-icon">‚óÜ</span>
                    <h2>√âtat du Syst√®me</h2>
                </div>
                <div class="status-grid">
                    <div class="status-block">
                        <div class="status-indicator-wrapper">
                            <span class="status-dot" id="ffeStatus"></span>
                            <span class="status-pulse" id="ffePulse"></span>
                        </div>
                        <div class="status-info">
                            <span class="status-label">Connexion FFE</span>
                            <span class="status-value" id="ffeStatusText">En attente...</span>
                        </div>
                    </div>
                    <div class="status-block">
                        <div class="status-indicator-wrapper">
                            <span class="status-dot" id="surveillanceStatus"></span>
                            <span class="status-pulse" id="surveillancePulse"></span>
                        </div>
                        <div class="status-info">
                            <span class="status-label">Surveillance</span>
                            <span class="status-value" id="surveillanceStatusText">En attente...</span>
                        </div>
                    </div>
                </div>
                <div class="last-update">
                    <span class="update-icon">‚Üª</span>
                    <span id="lastUpdate">‚Äî</span>
                </div>
                <div class="test-notifications">
                    <span class="test-label">Tester les notifications :</span>
                    <button class="btn-test" id="testTelegram" title="Tester Telegram">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.44-.751-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.141.121.1.154.234.169.348-.001.052.014.21-.012.328z"/></svg>
                    </button>
                    <button class="btn-test" id="testEmail" title="Tester Email">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                    </button>
                </div>
            </section>

            <!-- Add Concours Card -->
            <section class="bento-card card-add">
                <div class="card-header">
                    <span class="card-icon">+</span>
                    <h2>Nouveau Concours</h2>
                </div>
                <form id="addForm" class="add-form">
                    <div class="input-wrapper">
                        <input
                            type="number"
                            id="numeroInput"
                            placeholder="N¬∞ du concours"
                            min="1"
                            required
                            autocomplete="off"
                        >
                        <div class="input-border"></div>
                    </div>
                    <button type="submit" id="addButton" class="btn-add">
                        <span class="btn-text">Surveiller</span>
                        <span class="btn-icon">‚Üí</span>
                    </button>
                </form>
                <p id="formMessage" class="form-message"></p>
            </section>

            <!-- Stats Card - Small -->
            <section class="bento-card card-stats">
                <div class="stats-number" id="concoursCount">0</div>
                <div class="stats-label">Concours<br>Surveill√©s</div>
                <div class="stats-decoration"></div>
            </section>

            <!-- Global Stats Card -->
            <section class="bento-card card-global-stats">
                <div class="card-header">
                    <span class="card-icon">üìä</span>
                    <h2>Statistiques</h2>
                </div>
                <div class="global-stats-grid">
                    <div class="stat-item">
                        <span class="stat-value" id="statTotalChecks">0</span>
                        <span class="stat-label">V√©rifications</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statChecksToday">0</span>
                        <span class="stat-label">Aujourd'hui</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statOpenings">0</span>
                        <span class="stat-label">Ouvertures</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="statAvgTime">0</span>
                        <span class="stat-label">ms moy.</span>
                    </div>
                </div>
            </section>

            <!-- Concours List Card -->
            <section class="bento-card card-list">
                <div class="card-header">
                    <span class="card-icon">‚ò∞</span>
                    <h2>Concours en Surveillance</h2>
                </div>

                <div id="emptyState" class="empty-state">
                    <div class="empty-icon">
                        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="2" stroke-dasharray="8 4"/>
                            <path d="M35 50 L45 60 L65 40" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.3"/>
                        </svg>
                    </div>
                    <p class="empty-title">Aucun concours surveill√©</p>
                    <p class="empty-hint">Ajoutez un num√©ro de concours pour d√©marrer la surveillance automatique</p>
                </div>

                <div id="concoursContainer" class="concours-grid" style="display: none;">
                    <!-- Concours cards will be inserted here -->
                </div>
            </section>

            <!-- Calendar Card -->
            <section class="bento-card card-calendar">
                <div class="card-header">
                    <span class="card-icon">üìÖ</span>
                    <h2>Calendrier</h2>
                    <div class="calendar-nav">
                        <button class="cal-nav-btn" id="calPrev" title="Mois pr√©c√©dent">‚Üê</button>
                        <span class="cal-month-label" id="calMonthLabel"></span>
                        <button class="cal-nav-btn" id="calNext" title="Mois suivant">‚Üí</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <div class="cal-header">Lun</div>
                    <div class="cal-header">Mar</div>
                    <div class="cal-header">Mer</div>
                    <div class="cal-header">Jeu</div>
                    <div class="cal-header">Ven</div>
                    <div class="cal-header">Sam</div>
                    <div class="cal-header">Dim</div>
                </div>
                <div class="calendar-legend">
                    <span class="legend-item"><span class="legend-dot engagement"></span> Engagement ouvert</span>
                    <span class="legend-item"><span class="legend-dot demande"></span> Demande ouverte</span>
                    <span class="legend-item"><span class="legend-dot ferme"></span> Ferm√©</span>
                </div>
            </section>

            <!-- Activity Chart Card -->
            <section class="bento-card card-chart">
                <div class="card-header">
                    <span class="card-icon">üìà</span>
                    <h2>Activit√©</h2>
                    <div class="chart-period-toggle">
                        <button class="period-btn active" data-period="24h">24h</button>
                        <button class="period-btn" data-period="7d">7 jours</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <span class="footer-brand">FFE Monitor</span>
                <span class="footer-divider">‚Ä¢</span>
                <span class="footer-version">v1.0</span>
                <span class="footer-divider">‚Ä¢</span>
                <span class="footer-refresh">Actualisation automatique</span>
            </div>
        </footer>
    </div>

    <script>
        /**
         * FFE Monitor ‚Äî Application principale (prot√©g√©e)
         */

        const API_BASE = '';
        const REFRESH_INTERVAL = 3000;
        const TOKEN_KEY = 'ffemonitor_token';
        const THEME_KEY = 'ffemonitor_theme';

        let refreshTimer = null;
        let authToken = localStorage.getItem(TOKEN_KEY);

        // ============================================================================
        // Theme Manager
        // ============================================================================

        const ThemeManager = {
            init() {
                const savedTheme = localStorage.getItem(THEME_KEY);
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (prefersDark ? 'dark' : 'light');
                this.setTheme(theme);

                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem(THEME_KEY)) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            },

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem(THEME_KEY, theme);
            },

            toggle() {
                const current = document.documentElement.getAttribute('data-theme') || 'dark';
                const newTheme = current === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
            },

            get current() {
                return document.documentElement.getAttribute('data-theme') || 'dark';
            }
        };

        // Initialize theme immediately to prevent flash
        ThemeManager.init();

        // V√©rification imm√©diate de l'authentification
        if (!authToken) {
            window.location.href = '/login';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // V√©rifier le token c√¥t√© serveur
            verifyAndInit();
        });

        async function verifyAndInit() {
            try {
                const response = await fetch(`${API_BASE}/auth/verify`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    logout();
                    return;
                }

                // Token valide, initialiser l'app
                initApp();
            } catch (error) {
                logout();
            }
        }

        // Activity Chart instance
        let activityChart = null;
        let currentPeriod = '24h';

        // Calendar state
        let calendarMonth = new Date().getMonth() + 1;
        let calendarYear = new Date().getFullYear();
        let calendarEvents = [];

        function initApp() {
            document.getElementById('addForm').addEventListener('submit', handleAddConcours);
            document.getElementById('logoutButton').addEventListener('click', logout);
            document.getElementById('themeToggle').addEventListener('click', () => ThemeManager.toggle());
            document.getElementById('testTelegram').addEventListener('click', () => testNotification('telegram'));
            document.getElementById('testEmail').addEventListener('click', () => testNotification('email'));

            // Initialize chart period toggle buttons
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentPeriod = e.target.dataset.period;
                    loadActivityChart();
                });
            });

            // Initialize calendar navigation
            document.getElementById('calPrev').addEventListener('click', () => {
                calendarMonth--;
                if (calendarMonth < 1) {
                    calendarMonth = 12;
                    calendarYear--;
                }
                loadCalendar();
            });

            document.getElementById('calNext').addEventListener('click', () => {
                calendarMonth++;
                if (calendarMonth > 12) {
                    calendarMonth = 1;
                    calendarYear++;
                }
                loadCalendar();
            });

            loadConcours();
            loadStatus();
            loadGlobalStats();
            loadActivityChart();
            loadCalendar();
            startAutoRefresh();
        }

        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                loadConcours();
                loadStatus();
                loadGlobalStats();
            }, REFRESH_INTERVAL);
        }

        function logout() {
            localStorage.removeItem(TOKEN_KEY);
            window.location.href = '/login';
        }

        async function testNotification(type) {
            const btn = document.getElementById(type === 'telegram' ? 'testTelegram' : 'testEmail');
            btn.disabled = true;
            btn.classList.add('loading');

            try {
                const response = await fetch(`/test-${type}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                });

                const data = await response.json();
                if (data.success) {
                    showMessage(data.message, 'success');
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage(`Erreur: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
            }
        }

        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`,
                'Content-Type': 'application/json',
            };
        }

        async function authenticatedFetch(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: { ...getAuthHeaders(), ...(options.headers || {}) },
            });

            if (response.status === 401) {
                logout();
                throw new Error('Session expir√©e');
            }

            return response;
        }

        async function loadConcours() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/concours`);
                if (!response.ok) throw new Error('Erreur chargement');

                const data = await response.json();
                renderConcoursList(data.concours);
                updateCount(data.total);
            } catch (error) {
                if (error.message !== 'Session expir√©e') {
                    console.error('Erreur chargement concours:', error);
                }
            }
        }

        async function loadStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (!response.ok) throw new Error('Erreur status');

                const data = await response.json();
                updateStatusBar(data);
            } catch (error) {
                console.error('Erreur chargement status:', error);
                updateStatusBar({ ffe_connected: false, surveillance_active: false });
            }
        }

        async function loadGlobalStats() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/stats/global`);
                if (!response.ok) throw new Error('Erreur stats');

                const data = await response.json();
                updateGlobalStats(data);
            } catch (error) {
                if (error.message !== 'Session expir√©e') {
                    console.error('Erreur chargement stats:', error);
                }
            }
        }

        function updateGlobalStats(stats) {
            document.getElementById('statTotalChecks').textContent = formatNumber(stats.total_checks);
            document.getElementById('statChecksToday').textContent = formatNumber(stats.checks_today);
            document.getElementById('statOpenings').textContent = formatNumber(stats.total_openings);
            document.getElementById('statAvgTime').textContent = Math.round(stats.avg_response_time_ms);
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        async function loadActivityChart() {
            try {
                const response = await authenticatedFetch(`${API_BASE}/stats/activity?period=${currentPeriod}`);
                if (!response.ok) throw new Error('Erreur activity data');

                const data = await response.json();
                renderActivityChart(data);
            } catch (error) {
                if (error.message !== 'Session expir√©e') {
                    console.error('Erreur chargement activit√©:', error);
                }
            }
        }

        // ============================================================================
        // Calendar
        // ============================================================================

        async function loadCalendar() {
            try {
                // Update month label
                const monthNames = [
                    'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                    'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'
                ];
                document.getElementById('calMonthLabel').textContent =
                    `${monthNames[calendarMonth - 1]} ${calendarYear}`;

                // Fetch events for this month
                const response = await authenticatedFetch(
                    `${API_BASE}/calendar/events?month=${calendarMonth}&year=${calendarYear}`
                );

                if (response.ok) {
                    const data = await response.json();
                    calendarEvents = data.events;
                }

                renderCalendar();
            } catch (error) {
                if (error.message !== 'Session expir√©e') {
                    console.error('Erreur chargement calendrier:', error);
                }
                renderCalendar();
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');

            // Clear existing days (keep headers) using safe DOM methods
            const existingDays = grid.querySelectorAll('.cal-day');
            existingDays.forEach(day => day.remove());

            // Get first day of month and total days
            const firstDay = new Date(calendarYear, calendarMonth - 1, 1);
            const lastDay = new Date(calendarYear, calendarMonth, 0);
            const totalDays = lastDay.getDate();

            // Adjust for Monday start (0 = Monday, 6 = Sunday)
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            // Today for highlighting
            const today = new Date();
            const isCurrentMonth = today.getMonth() + 1 === calendarMonth && today.getFullYear() === calendarYear;

            // Create events map by day
            const eventsByDay = {};
            calendarEvents.forEach(event => {
                if (event.date_debut) {
                    const date = new Date(event.date_debut);
                    if (date.getMonth() + 1 === calendarMonth && date.getFullYear() === calendarYear) {
                        const day = date.getDate();
                        if (!eventsByDay[day]) eventsByDay[day] = [];
                        eventsByDay[day].push(event);
                    }
                }
            });

            // Add empty cells for days before month starts
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'cal-day empty';
                grid.appendChild(emptyCell);
            }

            // Add days
            for (let day = 1; day <= totalDays; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'cal-day';

                if (isCurrentMonth && day === today.getDate()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('span');
                dayNumber.className = 'cal-day-number';
                dayNumber.textContent = day;
                dayCell.appendChild(dayNumber);

                // Add event dots if there are events
                const dayEvents = eventsByDay[day];
                if (dayEvents && dayEvents.length > 0) {
                    dayCell.classList.add('has-event');

                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'cal-event-dots';

                    // Show up to 3 dots
                    dayEvents.slice(0, 3).forEach(event => {
                        const dot = document.createElement('span');
                        dot.className = `cal-event-dot ${event.statut}`;
                        dotsContainer.appendChild(dot);
                    });

                    dayCell.appendChild(dotsContainer);

                    // Add tooltip with concours name
                    const tooltip = document.createElement('div');
                    tooltip.className = 'cal-tooltip';
                    const tooltipText = dayEvents.map(e => e.nom || `#${e.numero}`).join(', ');
                    tooltip.textContent = tooltipText;
                    dayCell.appendChild(tooltip);

                    // Click to open FFE page
                    dayCell.addEventListener('click', () => {
                        const firstEvent = dayEvents[0];
                        window.open(`https://ffecompet.ffe.com/concours/${encodeURIComponent(firstEvent.numero)}`, '_blank');
                    });
                }

                grid.appendChild(dayCell);
            }
        }

        function renderActivityChart(data) {
            const ctx = document.getElementById('activityChart');
            if (!ctx) return;

            // Get computed styles for theme-aware colors
            const computedStyle = getComputedStyle(document.documentElement);
            const goldColor = computedStyle.getPropertyValue('--gold').trim() || '#C9A227';
            const successColor = computedStyle.getPropertyValue('--success-light').trim() || '#5D9B70';
            const creamColor = computedStyle.getPropertyValue('--cream').trim() || '#F5F0E8';

            // Destroy existing chart
            if (activityChart) {
                activityChart.destroy();
            }

            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'V√©rifications',
                            data: data.checks,
                            borderColor: goldColor,
                            backgroundColor: goldColor + '20',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 5,
                        },
                        {
                            label: 'Ouvertures',
                            data: data.openings,
                            borderColor: successColor,
                            backgroundColor: successColor + '20',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointStyle: 'star',
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            align: 'end',
                            labels: {
                                color: creamColor,
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    family: "'DM Sans', sans-serif",
                                    size: 11,
                                },
                            },
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            titleColor: creamColor,
                            bodyColor: creamColor,
                            borderColor: goldColor,
                            borderWidth: 1,
                            padding: 12,
                            titleFont: {
                                family: "'DM Sans', sans-serif",
                                weight: '600',
                            },
                            bodyFont: {
                                family: "'DM Sans', sans-serif",
                            },
                        },
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(245, 240, 232, 0.06)',
                            },
                            ticks: {
                                color: 'rgba(245, 240, 232, 0.5)',
                                font: {
                                    family: "'DM Sans', sans-serif",
                                    size: 10,
                                },
                            },
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(245, 240, 232, 0.06)',
                            },
                            ticks: {
                                color: 'rgba(245, 240, 232, 0.5)',
                                font: {
                                    family: "'DM Sans', sans-serif",
                                    size: 10,
                                },
                                stepSize: 1,
                            },
                        },
                    },
                },
            });
        }

        async function handleAddConcours(event) {
            event.preventDefault();

            const input = document.getElementById('numeroInput');
            const button = document.getElementById('addButton');
            const btnText = button.querySelector('.btn-text');

            const numero = parseInt(input.value);
            if (!numero || numero <= 0) {
                showMessage('Veuillez entrer un num√©ro de concours valide', 'error');
                return;
            }

            button.disabled = true;
            btnText.textContent = 'Ajout...';

            try {
                const response = await authenticatedFetch(`${API_BASE}/concours`, {
                    method: 'POST',
                    body: JSON.stringify({ numero }),
                });

                if (response.status === 201) {
                    showMessage(`Concours ${numero} ajout√© √† la surveillance`, 'success');
                    input.value = '';
                    loadConcours();
                } else if (response.status === 409) {
                    showMessage(`Le concours ${numero} est d√©j√† surveill√©`, 'error');
                } else {
                    throw new Error('Erreur serveur');
                }
            } catch (error) {
                if (error.message !== 'Session expir√©e') {
                    showMessage('Erreur lors de l\'ajout du concours', 'error');
                }
            } finally {
                button.disabled = false;
                btnText.textContent = 'Surveiller';
            }
        }

        async function deleteConcours(numero) {
            if (!confirm(`Retirer le concours ${numero} de la surveillance ?`)) return;

            try {
                const response = await authenticatedFetch(`${API_BASE}/concours/${numero}`, {
                    method: 'DELETE',
                });

                if (response.ok) {
                    loadConcours();
                } else {
                    alert('Erreur lors de la suppression');
                }
            } catch (error) {
                if (error.message !== 'Session expir√©e') {
                    alert('Erreur lors de la suppression');
                }
            }
        }

        function renderConcoursList(concours) {
            const container = document.getElementById('concoursContainer');
            const emptyState = document.getElementById('emptyState');

            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (concours.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'flex';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            concours.forEach((c, index) => {
                const card = document.createElement('div');
                card.className = `concours-card status-${c.statut}`;
                card.style.animationDelay = `${index * 0.05}s`;

                const header = document.createElement('div');
                header.className = 'concours-header';

                const titleWrapper = document.createElement('div');
                titleWrapper.className = 'concours-title-wrapper';

                // Nom du concours (titre principal)
                const nom = document.createElement('div');
                nom.className = 'concours-nom';
                nom.textContent = c.nom || `#${c.numero}`;

                // Sous-titre: lieu et date (num√©ro seulement si on a un nom)
                const subtitle = document.createElement('div');
                subtitle.className = 'concours-subtitle';
                let subtitleParts = [];
                if (c.nom) {
                    subtitleParts.push(`#${c.numero}`);
                }
                if (c.lieu && (!c.nom || !c.nom.includes(c.lieu))) {
                    subtitleParts.push(c.lieu);
                }
                if (c.date_debut) {
                    subtitleParts.push(formatDateShort(c.date_debut));
                }
                subtitle.textContent = subtitleParts.join(' ‚Ä¢ ');

                titleWrapper.appendChild(nom);
                titleWrapper.appendChild(subtitle);

                const actions = document.createElement('div');
                actions.className = 'concours-actions';
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-delete';
                deleteBtn.textContent = '√ó';
                deleteBtn.title = 'Retirer de la surveillance';
                deleteBtn.addEventListener('click', () => deleteConcours(c.numero));
                actions.appendChild(deleteBtn);

                header.appendChild(titleWrapper);
                header.appendChild(actions);

                const meta = document.createElement('div');
                meta.className = 'concours-meta';

                const statusBadge = document.createElement('span');
                statusBadge.className = `concours-badge badge-status ${c.statut}`;
                statusBadge.textContent = formatStatut(c.statut);
                meta.appendChild(statusBadge);

                // Badge notification seulement si le concours est ouvert
                if (c.statut !== 'ferme') {
                    const notifBadge = document.createElement('span');
                    notifBadge.className = `concours-badge badge-notif ${c.notifie ? 'sent' : 'pending'}`;
                    notifBadge.textContent = c.notifie ? 'Notification envoy√©e' : 'Notification en attente';
                    meta.appendChild(notifBadge);
                }

                const timeInfo = document.createElement('div');
                timeInfo.className = 'concours-time';
                timeInfo.textContent = `Derni√®re v√©rification : ${formatDate(c.last_check)}`;

                const accessBtn = document.createElement('a');
                accessBtn.href = `https://ffecompet.ffe.com/concours/${encodeURIComponent(c.numero)}`;
                accessBtn.target = '_blank';
                accessBtn.rel = 'noopener noreferrer';
                accessBtn.className = 'btn-access';
                accessBtn.innerHTML = `
                    <span>Acc√©der au concours</span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 17L17 7M17 7H7M17 7V17"/>
                    </svg>
                `;

                card.appendChild(header);
                card.appendChild(meta);
                card.appendChild(timeInfo);
                card.appendChild(accessBtn);

                container.appendChild(card);
            });
        }

        function updateStatusBar(status) {
            const ffeIndicator = document.getElementById('ffeStatus');
            const ffeText = document.getElementById('ffeStatusText');
            const survIndicator = document.getElementById('surveillanceStatus');
            const survText = document.getElementById('surveillanceStatusText');
            const lastUpdate = document.getElementById('lastUpdate');

            ffeIndicator.className = status.ffe_connected ? 'status-dot connected' : 'status-dot disconnected';
            ffeText.textContent = status.ffe_connected ? 'Connect√©' : 'D√©connect√©';

            survIndicator.className = status.surveillance_active ? 'status-dot connected' : 'status-dot disconnected';
            survText.textContent = status.surveillance_active ? 'Active' : 'Inactive';

            const now = new Date();
            lastUpdate.textContent = `Mise √† jour : ${now.toLocaleTimeString('fr-FR', {
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            })}`;
        }

        function updateCount(count) {
            const countEl = document.getElementById('concoursCount');
            const currentCount = parseInt(countEl.textContent) || 0;

            if (currentCount !== count) {
                countEl.style.transform = 'scale(1.1)';
                countEl.textContent = count;
                setTimeout(() => { countEl.style.transform = 'scale(1)'; }, 200);
            }
        }

        function formatStatut(statut) {
            const labels = {
                'previsionnel': 'Pr√©visionnel',
                'engagement': 'Ouvert',
                'demande': 'Demande',
                'cloture': 'Cl√¥tur√©',
                'en_cours': 'En cours',
                'termine': 'Termin√©',
                'annule': 'Annul√©',
                'ferme': 'Inconnu'
            };
            return labels[statut] || statut;
        }

        function formatDate(isoString) {
            if (!isoString) return '‚Äî';
            const date = new Date(isoString);
            return date.toLocaleString('fr-FR', {
                day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        }

        function formatDateShort(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString('fr-FR', {
                day: 'numeric', month: 'short'
            });
        }

        function showMessage(text, type) {
            const messageEl = document.getElementById('formMessage');
            messageEl.textContent = text;
            messageEl.className = `form-message ${type}`;
            setTimeout(() => { messageEl.className = 'form-message'; }, 5000);
        }
    </script>
</body>
</html>
